<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="keywords" content="知识铺">
        <meta name="description" content="《浏览器端测试：mocha，chai，phantomjs》 目标 建立一个 lesson7 项目，在其中编写代码，我们暂时命名为 vendor 根据下面的步骤，最终的项目结构">
        <link rel="alternate" href="https://blog.zshipu.com/article/feed.xml" type="application/rss+xml" title="知识铺">
        <link rel="icon" href="https://blog.zshipu.com/article/favicon.ico">
        <title>lesson7- 浏览器端测试：mocha，chai，phantomjs - 知识铺</title>
        <link rel="stylesheet" href="https://blog.zshipu.com/article/css/highlight.js.min.css">
        <link rel="stylesheet" href="https://blog.zshipu.com/article/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://blog.zshipu.com/article/css/bootstrap-theme.css">
        <link rel="stylesheet" href="https://blog.zshipu.com/article/css/font-awesome/css/font-awesome.min.css" />
        
        <link rel="stylesheet" href="https://blog.zshipu.com/article/css/hugo-org.css">
        
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-WLWJSST');</script>
        
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({
                google_ad_client: "ca-pub-2874221941555456",
                enable_page_level_ads: true
            });
        </script>
    </head>

<body role="document">
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://blog.zshipu.com/article/">知识铺</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li ><a href="https://blog.zshipu.com/">主页</a></li>
                    
                    
                    <li ><a href="https://blog.zshipu.com/article/post/">文章列表</a></li>
                    
                </ul>
            </div>
        </div>
    </nav>



<div class="container">
<div class="row">
    <div class="col-xs-12 col-sm-11 doc-main">
        <main role="main">
            <article>
                <a id="title"></a>
                <h1 class="doc-entry-title">lesson7- 浏览器端测试：mocha，chai，phantomjs</h1>
                
                <div class="doc-entry-meta small">
                    <span><time datetime="2019-10-20">2019-10-20</time> by 知识铺 </span>
                </div>
                
                <section>
                    

<h1 id="浏览器端测试-mocha-chai-phantomjs">《浏览器端测试：mocha，chai，phantomjs》</h1>

<h2 id="目标">目标</h2>

<p>建立一个 lesson7 项目，在其中编写代码，我们暂时命名为 <em>vendor</em>
根据下面的步骤，最终的项目结构应该长<a href="https://github.com/alsotang/node-lessons/tree/master/lesson7/vendor">这样</a></p>

<p>这次我们测试的对象是上文提到的 fibonacci 函数</p>

<p>此函数的定义为 <code>int fibonacci(int n)</code></p>

<ul>
<li>当 n === 0 时，返回 0；n === 1时，返回 1;</li>
<li>n &gt; 1 时，返回 <code>fibonacci(n) === fibonacci(n-1) + fibonacci(n-2)</code>，如 <code>fibonacci(10) === 55</code>;</li>
</ul>

<h2 id="知识点">知识点</h2>

<ol>
<li>学习使用测试框架 mocha 进行前端测试 : <a href="http://mochajs.org/">http://mochajs.org/</a></li>
<li>了解全栈的断言库 chai: <a href="http://chaijs.com/">http://chaijs.com/</a></li>
<li>了解 headless 浏览器 phantomjs: <a href="http://phantomjs.org/">http://phantomjs.org/</a></li>
</ol>

<h3 id="前端脚本单元测试">前端脚本单元测试</h3>

<p><a href="https://github.com/alsotang/node-lessons/tree/master/lesson6">lesson6</a> 的内容都是针对后端环境中 node 的一些单元测试方案，出于应用健壮性的考量，针对前端 js 脚本的单元测试也非常重要。而前后端通吃，也是 mocha 的一大特点。</p>

<p>首先，前端脚本的单元测试主要有两个困难需要解决。</p>

<ol>
<li><p>运行环境应当在浏览器中，可以操纵浏览器的DOM对象，且可以随意定义执行时的 html 上下文。</p></li>

<li><p>测试结果应当可以直接反馈给 mocha，判断测试是否通过。</p></li>
</ol>

<h4 id="浏览器环境执行">浏览器环境执行</h4>

<p>我们首先搭建一个测试原型，用 mocha 自带的脚手架可以自动生成。</p>

<pre><code class="language-shell">cd vendor            # 进入我们的项目文件夹
npm i -g mocha       # 安装全局的 mocha 命令行工具
mocha init .         # 生成脚手架
</code></pre>

<p>mocha就会自动帮我们生成一个简单的测试原型, 目录结构如下</p>

<pre><code class="language-shell">.
├── index.html       # 这是前端单元测试的入口
├── mocha.css
├── mocha.js
└── tests.js         # 我们的单元测试代码将在这里编写
</code></pre>

<p>其中 index.html 是单元测试的入口，tests.js 是我们的测试用例文件。</p>

<p>我们直接在 index.html 插入上述示例的 fibonacci 函数以及断言库 chaijs。</p>

<pre><code class="language-html">&lt;div id=&quot;mocha&quot;&gt;&lt;/div&gt;
&lt;script src='https://cdn.rawgit.com/chaijs/chai/master/chai.js'&gt;&lt;/script&gt;
&lt;script&gt;
  var fibonacci = function (n) {
    if (n === 0) {
      return 0;
    }
    if (n === 1) {
      return 1;
    }
    return fibonacci(n-1) + fibonacci(n-2);
  };
&lt;/script&gt;
</code></pre>

<p>然后在tests.js中写入对应测试用例</p>

<pre><code class="language-js">var should = chai.should();
describe('simple test', function () {
  it('should equal 0 when n === 0', function () {
    window.fibonacci(0).should.equal(0);
  });
});
</code></pre>

<p>这时打开index.html，可以发现测试结果，我们完成了浏览器端的脚本测试(注意我们调用了 <strong>window</strong> 对象)</p>

<p><img src="https://raw.githubusercontent.com/alsotang/node-lessons/master/lesson7/1.png" alt="" /></p>

<h4 id="测试反馈">测试反馈</h4>

<p>mocha没有提供一个命令行的前端脚本测试环境(因为我们的脚本文件需要运行在浏览器环境中)，因此我们使用phantomjs帮助我们搭建一个模拟环境。不重复制造轮子，这里直接使用mocha-phantomjs帮助我们在命令行运行测试。</p>

<p>首先安装mocha-phantomjs</p>

<pre><code class="language-shell">npm i -g mocha-phantomjs
</code></pre>

<p>然后在 index.html 的页面下加上这段兼容代码</p>

<pre><code class="language-html">&lt;script&gt;mocha.run()&lt;/script&gt;
</code></pre>

<p>改为</p>

<pre><code class="language-html">&lt;script&gt;
  if (window.initMochaPhantomJS &amp;&amp; window.location.search.indexOf('skip') === -1) {
    initMochaPhantomJS()
  }
  mocha.ui('bdd');
  expect = chai.expect;
  
  mocha.run();
&lt;/script&gt;
</code></pre>

<p>这时候, 我们在命令行中运行</p>

<pre><code class="language-shell">mocha-phantomjs index.html --ssl-protocol=any --ignore-ssl-errors=true
</code></pre>

<p>结果展现是不是和后端代码测试很类似 :smile:</p>

<p>更进一步，我们可以直接在 package.json 的 scripts 中添加
(package.json 通过 <code>npm init</code> 生成，这里不再赘述)</p>

<pre><code class="language-json">&quot;scripts&quot;: {
  &quot;test&quot;: &quot;mocha-phantomjs index.html --ssl-protocol=any --ignore-ssl-errors=true&quot;
},
</code></pre>

<p>将mocha-phantomjs作为依赖</p>

<pre><code class="language-shell">npm i mocha-phantomjs --save-dev
</code></pre>

<p>直接运行</p>

<pre><code class="language-shell">npm test
</code></pre>

<p>运行结果如下:</p>

<p>至此,我们实现了前端脚本的单元测试，基于 phanatomjs 你几乎可以调用所有的浏览器方法，而 mocha-phanatomjs 也可以很便捷地将测试结果反馈到 mocha，便于后续的持续集成。</p>

                </section>
            </article>
        </main>
    </div> 
    
<div class="col-xs-12 col-sm-3 doc-sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4>Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">lesson7- 浏览器端测试：mocha，chai，phantomjs</a></strong></li>
			</ul>
			<nav id="TableOfContents">
<ul>
<li><a href="#浏览器端测试-mocha-chai-phantomjs">《浏览器端测试：mocha，chai，phantomjs》</a>
<ul>
<li><a href="#目标">目标</a></li>
<li><a href="#知识点">知识点</a>
<ul>
<li><a href="#前端脚本单元测试">前端脚本单元测试</a>
<ul>
<li><a href="#浏览器环境执行">浏览器环境执行</a></li>
<li><a href="#测试反馈">测试反馈</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
		</div>
	</div>
	<div class="sidebar-module">
		<h4>Tags</h4>
		<div class="tag-box">
		
		</div>
	</div>
</div>

</div> 



<hr />

<div class="row">
    <div class="col-sm-12">
        
	    <div class="text-center">
        
		    <p class="doc-footer-em"><a href="#">回到顶部↑</a></p>
	    </div>
	</div>
</div>

</div> 

<footer class="doc-footer">
	
    <p>Copyright © <a href="https://blog.zshipu.com/">知识铺</a> 2019. Generated by <a href="http://gohugo.io/">Hugo</a></p>
</footer>



<script src="https://blog.zshipu.com/article/js/jquery-1.11.2.min.js"></script>
<script src="https://blog.zshipu.com/article/js/bootstrap.min.js"></script>

<script src="https://blog.zshipu.com/article/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://blog.zshipu.com/article/js/ie10-viewport-bug-workaround.js"></script>

<div style="position:absolute; bottom: 0; right: 0;">
	<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=962982601&auto=1&height=90"></iframe>
</div>
<script>
	(function(){
		var bp = document.createElement('script');
		var curProtocol = window.location.protocol.split(':')[0];
		if (curProtocol === 'https') {
			bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
		}
		else {
			bp.src = 'http://push.zhanzhang.baidu.com/push.js';
		}
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(bp, s);
	})();
</script>

</body>
</html>

